#!/usr/bin/env bash

set -u

# shellcheck source=/dev/null
{
  source "${SCRIPT_DIR}/../include/tfmake/utils.sh"
  source "${SCRIPT_DIR}/../include/tfmake/store.sh"
}

file::exist_condition \
  "${DATA_DIR}/plan/Makefile" \
  "tfmake makefile --plan"

truncate -s 0 "${DATA_DIR}/plan/outputs/visited"

export TF_IN_AUTOMATION=true
make -i -f "${DATA_DIR}/plan/Makefile" 2> "${DATA_DIR}/plan/logs/signpost.log"

store::basepath "${DATA_DIR}/plan/store"
store::kv visited

exit_code=0

if [[ -f "${DATA_DIR}/plan/outputs/visited" ]]; then
  nodes=$(cat "${DATA_DIR}/plan/outputs/visited")

  for node in ${nodes}; do
    value=true

    grep -qE "make: \[.*${node}\] Error .+" "${DATA_DIR}/plan/logs/signpost.log"
    [[ $? -eq 0 ]] && value=false && exit_code=1

    kv::set "${node}" "${value}"
  done
fi

rm -f "${DATA_DIR}/plan/outputs/visited"

exit "${exit_code}"
