#!/usr/bin/env bash

readonly BACKTICKS='```'
readonly SUMMARY="${DATA_DIR}/outputs/plan/summary.md"

if [[ ! -f "${DATA_DIR}/outputs/plan/mermaid.md" ]]; then
    cat << EOF
Error: file "${DATA_DIR}/outputs/plan/mermaid.md" does not exist.

>>> Run 'tfmake mermaid --plan' first."
EOF
    exit 1
fi

truncate -s 0 "${SUMMARY}"

# mermaid
cat >> "${SUMMARY}" << EOF
${BACKTICKS}mermaid
$(cat "${DATA_DIR}/outputs/plan/mermaid.md")
${BACKTICKS}
EOF

# init and plan logs
if [[ -f ${DATA_DIR}/outputs/plan/visited ]]; then
    nodes=$(cat "${DATA_DIR}/outputs/plan/visited")

    for node in ${nodes}; do
        cat >> "${SUMMARY}" << EOF
<details>
<summary>Module <strong>"${node}"</strong> Plan</summary>

${BACKTICKS}
$(cat "${DATA_DIR}/logs/plan/${node}/init.log")
${BACKTICKS}

${BACKTICKS}
$(cat "${DATA_DIR}/logs/plan/${node}/plan.log")
${BACKTICKS}

</details>	
EOF
    done
fi
