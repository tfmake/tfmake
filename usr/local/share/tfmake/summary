#!/usr/bin/env bash

set -u

# shellcheck source=/dev/null
{
  source "${SCRIPT_DIR}/../include/tfmake/utils.sh"
  source "${SCRIPT_DIR}/../include/tfmake/store.sh"
}

function usage() {
  cat << EOF
Usage:
  tfmake summary [options]

  This command create a Markdown summary.

Options:
  -h, --help, help  Show this help output.
  --no-diagram      The summary won't contain the Mermaid flowchart diagram.
  --no-outputs      The summary won't contain the Terraform outputs.
EOF
  exit
}

with_diagram=true
with_outputs=true

case "${1-}" in
-h|--help|help)
  usage
  ;;
--no-diagram)
  with_diagram=false
  ;;
--no-outputs)
  with_outputs=false
  ;;
?*)
  printf ">>> Unknown option: %s\n\n" "${1}"
  usage
  ;;
esac

# validations
MERMAID_FILE="${DATA_DIR}/${TFMAKE_CONTEXT}/outputs/mermaid.md"
SUMMARY_TITLE="${SUMMARY_TITLE:-"${TFMAKE_CONTEXT^}"}"
SUMMARY_FILE="${DATA_DIR}/${TFMAKE_CONTEXT}/outputs/summary.md"
BREADCRUMBS_FILE="${DATA_DIR}/${TFMAKE_CONTEXT}/outputs/breadcrumbs"

file::exist_condition \
  "${DATA_DIR}/${TFMAKE_CONTEXT}/store/visited/keys" \
  "tfmake run"

if [[ "${with_diagram}" == "true" ]]; then
  file::exist_condition \
    "${DATA_DIR}/${TFMAKE_CONTEXT}/outputs/mermaid.md" \
    "tfmake mermaid"
fi

# subcommand
function breadcrumb() {
  bytes=$(wc -c "${SUMMARY_FILE}" | awk '{print $1}')

  printf "%s\t%d\n" "${1-}" "${bytes}" >> "${BREADCRUMBS_FILE}"
}

truncate -s 0 "${SUMMARY_FILE}" "${BREADCRUMBS_FILE}"

# title
if [[ -n "${SUMMARY_TITLE}" ]]; then
  echo "### ${SUMMARY_TITLE}" > "${SUMMARY_FILE}"
  file::new_line "${SUMMARY_FILE}"

  breadcrumb "title"
fi

# diagram
if [[ "${with_diagram}" == "true" ]]; then
  cat >> "${SUMMARY_FILE}" << EOF
${BACKTICKS}mermaid
$(cat "${MERMAID_FILE}")
${BACKTICKS}
EOF

  file::new_line "${SUMMARY_FILE}"

  breadcrumb "diagram"
fi

# outputs
if [[ "${with_outputs}" == "true" ]]; then
  store::basepath "${DATA_DIR}/${TFMAKE_CONTEXT}/store"

  store::use visited
  nodes=$(kv::keys)

  for node in ${nodes}; do
    cat >> "${SUMMARY_FILE}" << EOF
<details>
<summary>Module <strong>"${node}"</strong></summary>

${BACKTICKS}
$(cat "${DATA_DIR}/${TFMAKE_CONTEXT}/logs/${node}/init.log")

--------------------------------------------------------------------------------

$(cat "${DATA_DIR}/${TFMAKE_CONTEXT}/logs/${node}/${TFMAKE_CONTEXT}.log")
${BACKTICKS}

</details>
EOF

    breadcrumb "module"
  done
fi
